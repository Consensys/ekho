## Description

Project Ekho - peer-to-peer communication module.

Check [detailed documentation](https://eoinco.github.io/ekho/).

## Installation

```bash
$ npm install
```

## Configuration

```bash
# .env contents
IPFS_HOST=ipfs.infura.io
IPFS_PORT=5001
```

## Running the app

### Requirements

- node `v11.9.0`
- docker v19 (working with `Docker version 19.03.5, build 633a0ea838`)
- docker-compose v1 (working with `docker-compose version 1.22.0, build f46880fe`)

```bash
# to use the correct node version
nvm use v11.9.0

# or as of now (2020/01/15), stable version points to v11.9.0
nvm use stable
```

### Development mode

```bash
# make sure the databse is up and running
$ docker-compose up

# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

Swagger endpoint should be accessible: http://localhost:3000/api/#

### Prod mode - single node

```bash
# use docker-compose-single-node
# 1) brings up postgres db
# 2) brings up ekho instance
$ docker-compose -f docker-compose-single-node.yml up

# to update existing containers with new code, rebuild new images
$ docker-compose -f docker-compose-single-node.yml down
$ docker-compose -f docker-compose-single-node.yml build
$ docker-compose -f docker-compose-single-node.yml up
```

Swagger endpoint should be accessible: http://localhost:3000/api/#

### Prod mode - dual node

```bash
# use docker-compose-dual-node
# 1) brings up postgres db1 and ekho1 in network1
# 2) brings up postgres db2 and ekho2 in network2
# Note: instance 1 and 2 are isolated by different networks
$ docker-compose -f docker-compose-dual-node.yml up

# to update existing containers with new code, rebuild new images
$ docker-compose -f docker-compose-dual-node.yml down
$ docker-compose -f docker-compose-dual-node.yml build
$ docker-compose -f docker-compose-dual-node.yml up
```

Swagger endpoints should be accessible:

- http://localhost:3100/api/#
- http://localhost:3200/api/#

Note: single and dual node can run simultaneosly, producing 3 separate instances locally

## Test

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
# write coverage reports to <rootDir>/coverage
# open <rootDir>/coverage/lcov-report/index.html to view locally.
# CI prefer <rootDir>/coverage/coverage-final.json
$ npm run test:cov
```

## Documentation

Detailed documentation can be found here: https://eoinco.github.io/ekho/.
This documentation is generated by compodoc and provided by github pages.
In order to update existing configuration in https://eoinco.github.io/ekho/,
simply run `./generate-documentation.sh`.
After reviewing it locally, add/commit/push the `./documentation`.

## Initial Setup

### Receiving all historical Blockchain Events

To download all historical blockchain events, prior to sending any messages, run the following:

URL: `/web3/refresh`

This will pull down all events emitted by the ekho contract, and make them ready for processing.

### Creating a User

To create a user:

URL: `/users`

Postdata:

Provide the user's name

### Adding a Contact

To add a contact:
First, create an init handshake

- POST: /contacts/generate-init-handshake/{userId}/{contactName}
  Provide your user ID and the name of the contact you want to add
  This generates an init handshake JSON, which you must send to your contact (off platform)

Second, your contact must accept the init handshake (this happens off platform)

- POST: /contacts/accept-init-handshake/{userId}/{contactName}
  Your contact provides their userId and the name they want to assign to you

Third, your contact must generate a reply handshake

- POST: /contacts/generate-reply-handshake/{userId}/{contactName}
  Your contact provides their userId and the name they assigned to you

Last, you must accept the reply handshake

- POST: /contacts/accept-reply-handshake/{userId}/{contactName}
  You must provide your userid and the name of the contact you used in the generate-init-handshake method initially

### Creating a Channel

In order to communicate, you must set up a channel with the required contact.

- POST: /channels
  Provide your userid, the contactid of the contact and the channel name

In order to receive your communications, your contact will need to perform the same action.

### Sending a Message

Messages are sent by a user to a channel.  
Ekho manages the creation of the underlying data file (currently via IPFS) and the blockchain event generation.

-POST: /channels/message
Provide:
$ the message contents (currently a text string only),
$ your user id
\$ the channel id

### Receiving a Message

To receive a message, you currently must have the channel set up and all blockchain events downloaded in advance of processing any blockchain events.

- POST: /channels/refresh
  This will process any received blockchain events and obtain the original message contents
